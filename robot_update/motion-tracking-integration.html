<!-- Motion Tracking Integration for WAVEGO -->
<!-- Add this script tag to the main HTML file after the BolliOs button -->

<script>
// Motion Tracking Extension - Auto Integration
(function() {
    'use strict';
    
    let motionTrackingActive = false;
    let integrationAttempts = 0;
    const maxAttempts = 10;
    
    console.log('WAVEGO Motion Tracking Integration starting...');

    function attemptIntegration() {
        integrationAttempts++;
        
        // Find where to insert the motion tracking controls
        const targetElement = findInsertionPoint();
        
        if (targetElement) {
            createMotionTrackingControls(targetElement);
            console.log(`Motion Tracking integrated successfully (attempt ${integrationAttempts})`);
            return true;
        } else if (integrationAttempts < maxAttempts) {
            console.log(`Motion Tracking integration attempt ${integrationAttempts} failed, retrying...`);
            setTimeout(attemptIntegration, 1000);
            return false;
        } else {
            console.warn('Motion Tracking integration failed after maximum attempts');
            return false;
        }
    }

    function findInsertionPoint() {
        // Method 1: Look for BolliOs button
        const buttons = document.querySelectorAll('button, input[type="button"], .button');
        for (let btn of buttons) {
            const text = btn.textContent || btn.value || '';
            if (text.toLowerCase().includes('bolli') || text.toLowerCase().includes('gyro')) {
                return btn.parentElement;
            }
        }
        
        // Method 2: Look for Actions section or Face Detection area
        const sections = document.querySelectorAll('div, section, .actions, .controls');
        for (let section of sections) {
            const text = section.textContent || '';
            if (text.toLowerCase().includes('face detection') || 
                text.toLowerCase().includes('actions') ||
                text.toLowerCase().includes('bolli')) {
                return section;
            }
        }
        
        // Method 3: Look for any control area
        const containers = document.querySelectorAll('.container, .control-panel, .robot-controls');
        if (containers.length > 0) {
            return containers[0];
        }
        
        // Method 4: Fallback to body
        return document.body;
    }

    function createMotionTrackingControls(parentElement) {
        // Remove existing motion tracking controls if they exist
        const existing = document.getElementById('motionTrackingContainer');
        if (existing) {
            existing.remove();
        }

        // Create main container
        const container = document.createElement('div');
        container.id = 'motionTrackingContainer';
        container.style.cssText = `
            margin: 15px 0;
            padding: 15px;
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.1) 0%, rgba(33, 150, 243, 0.05) 100%);
            border: 2px solid #2196F3;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(33, 150, 243, 0.2);
            transition: all 0.3s ease;
        `;

        // Create header with icon
        const header = document.createElement('div');
        header.style.cssText = `
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        `;

        const icon = document.createElement('span');
        icon.innerHTML = 'ðŸŽ¯';
        icon.style.cssText = `
            font-size: 18px;
            margin-right: 8px;
        `;

        const title = document.createElement('h4');
        title.textContent = 'Motion Tracking';
        title.style.cssText = `
            margin: 0;
            color: #1976D2;
            font-size: 16px;
            font-weight: 600;
        `;

        header.appendChild(icon);
        header.appendChild(title);

        // Create description
        const description = document.createElement('p');
        description.textContent = 'Silent motion detection - robot follows movement without beeping';
        description.style.cssText = `
            margin: 5px 0 12px 0;
            color: #666;
            font-size: 12px;
            font-style: italic;
        `;

        // Create control row
        const controlRow = document.createElement('div');
        controlRow.style.cssText = `
            display: flex;
            align-items: center;
            justify-content: space-between;
        `;

        // Create label
        const label = document.createElement('label');
        label.textContent = 'Follow Motion';
        label.style.cssText = `
            color: #333;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        `;

        // Create animated switch
        const switchContainer = document.createElement('div');
        switchContainer.className = 'motion-switch-container';
        switchContainer.style.cssText = `
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        `;

        const switchInput = document.createElement('input');
        switchInput.type = 'checkbox';
        switchInput.id = 'motionTrackingSwitch';
        switchInput.style.cssText = `
            opacity: 0;
            width: 0;
            height: 0;
        `;

        const slider = document.createElement('span');
        slider.className = 'motion-slider';
        slider.style.cssText = `
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 30px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        `;

        // Create slider knob
        const sliderKnob = document.createElement('span');
        sliderKnob.style.cssText = `
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 3px;
            bottom: 3px;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            transition: 0.4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        `;

        slider.appendChild(sliderKnob);

        // Create status display
        const statusDisplay = document.createElement('div');
        statusDisplay.id = 'motionTrackingStatus';
        statusDisplay.style.cssText = `
            margin-top: 10px;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            text-align: center;
            background-color: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
            transition: all 0.3s ease;
        `;
        statusDisplay.textContent = 'ðŸ”˜ Motion Tracking OFF';

        // Add CSS for switch animation
        const style = document.createElement('style');
        style.textContent = `
            #motionTrackingContainer .motion-switch-container input:checked + .motion-slider {
                background-color: #2196F3;
                box-shadow: inset 0 1px 3px rgba(33, 150, 243, 0.3);
            }
            
            #motionTrackingContainer .motion-switch-container input:checked + .motion-slider span {
                transform: translateX(30px);
                background: linear-gradient(145deg, #ffffff, #e3f2fd);
            }
            
            #motionTrackingContainer:hover {
                box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
            }
        `;
        document.head.appendChild(style);

        // Add event listeners
        switchInput.addEventListener('change', handleMotionToggle);
        label.addEventListener('click', () => {
            switchInput.checked = !switchInput.checked;
            handleMotionToggle();
        });

        // Assemble elements
        switchContainer.appendChild(switchInput);
        switchContainer.appendChild(slider);
        
        controlRow.appendChild(label);
        controlRow.appendChild(switchContainer);
        
        container.appendChild(header);
        container.appendChild(description);
        container.appendChild(controlRow);
        container.appendChild(statusDisplay);

        // Insert into page
        if (parentElement === document.body) {
            document.body.appendChild(container);
        } else {
            parentElement.appendChild(container);
        }

        console.log('Motion Tracking controls created and added to page');
    }

    function handleMotionToggle() {
        const switchInput = document.getElementById('motionTrackingSwitch');
        const statusDisplay = document.getElementById('motionTrackingStatus');
        
        motionTrackingActive = switchInput.checked;
        
        if (motionTrackingActive) {
            // Activate motion tracking
            sendMotionCommand('motionTracking');
            statusDisplay.textContent = 'ðŸ”µ Motion Tracking ON - Blue LEDs Active';
            statusDisplay.style.cssText = statusDisplay.style.cssText.replace(/background-color: [^;]+/, 'background-color: #E3F2FD') + '; border-color: #2196F3;';
            statusDisplay.style.color = '#1976D2';
            
            console.log('ðŸŽ¯ Motion Tracking ACTIVATED');
        } else {
            // Deactivate motion tracking
            sendMotionCommand('motionTrackingOff');
            statusDisplay.textContent = 'ðŸ”˜ Motion Tracking OFF';
            statusDisplay.style.cssText = statusDisplay.style.cssText.replace(/background-color: [^;]+/, 'background-color: #f5f5f5') + '; border-color: #ddd;';
            statusDisplay.style.color = '#666';
            
            console.log('ðŸŽ¯ Motion Tracking DEACTIVATED');
        }
    }

    function sendMotionCommand(command) {
        // Try multiple WebSocket connection methods
        const wsConnections = [
            window.websocket,
            window.ws,
            window.socket,
            window.webSocket
        ];
        
        let sent = false;
        
        for (let ws of wsConnections) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                try {
                    ws.send(command);
                    console.log(`Motion command '${command}' sent successfully`);
                    sent = true;
                    break;
                } catch (error) {
                    console.warn(`Failed to send via WebSocket: ${error.message}`);
                }
            }
        }
        
        if (!sent) {
            console.error(`Failed to send motion command '${command}' - no active WebSocket found`);
            // Could implement HTTP fallback here
        }
    }

    // Auto-start integration
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', attemptIntegration);
    } else {
        attemptIntegration();
    }

    // Expose global functions for debugging
    window.motionTracking = {
        toggle: handleMotionToggle,
        isActive: () => motionTrackingActive,
        sendCommand: sendMotionCommand,
        reintegrate: attemptIntegration
    };

})();
</script>